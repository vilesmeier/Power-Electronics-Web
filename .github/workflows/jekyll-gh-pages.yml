name: Build Doxygen and Deploy MkDocs

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. checkout public repo（不拉 submodule）
    - name: Checkout NUEDC
      uses: actions/checkout@v4
      with:
        submodules: false

    # 2. 设置 Python（MkDocs）
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install MkDocs
      run: |
        pip install mkdocs mkdocs-material

    # 3. 尝试拉取 Private Core（有权限才执行）
    - name: Setup SSH for Core
      if: secrets.CORE_DEPLOY_KEY != ''
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.CORE_DEPLOY_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts

    - name: Init core submodule
      if: secrets.CORE_DEPLOY_KEY != ''
      run: |
        git submodule update --init --recursive

    # 4. 生成 Doxygen（仅 core 存在时）
    - name: Generate Doxygen
      if: secrets.CORE_DEPLOY_KEY != ''
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz
        doxygen Doxyfile

    # 5. 构建 MkDocs
    - name: Build MkDocs
      run: |
        mkdocs build

    # 6. 部署到 GitHub Pages
    - name: Deploy to GitHub Pages
      run: |
        mkdocs gh-deploy --force
