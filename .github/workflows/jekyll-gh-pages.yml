name: Build Doxygen + MkDocs + Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install MkDocs
      run: pip install mkdocs mkdocs-material

    - name: Install Doxygen and dependencies
      run: sudo apt-get update && sudo apt-get install -y doxygen graphviz jq openssl python3-pip

    - name: Generate GitHub App token
      env:
        NUEDC_APP_ID: ${{ secrets.NUEDC_APP_ID }}
        NUEDC_APP_PEM: ${{ secrets.NUEDC_APP_PEM }}
        NUEDC_APP_INSTALLATION_ID: ${{ secrets.NUEDC_APP_INSTALLATION_ID }}
      run: |
        echo "$NUEDC_APP_PEM" | sed 's/\\n/\n/g' > app.pem
        python3 - <<EOF
        import os, jwt, time, json, requests
        app_id = int(os.environ["NUEDC_APP_ID"])
        installation_id = os.environ["NUEDC_APP_INSTALLATION_ID"]
        with open("app.pem","r") as f:
            private_key = f.read()
        iat = int(time.time())
        exp = iat + 600
        payload = {"iat": iat, "exp": exp, "iss": app_id}
        token = jwt.encode(payload, private_key, algorithm="RS256")
        headers = {"Authorization": f"Bearer {token}", "Accept": "application/vnd.github+json"}
        url = f"https://api.github.com/app/installations/{installation_id}/access_tokens"
        r = requests.post(url, headers=headers)
        print("TOKEN="+r.json()["token"])
        with open(os.environ["GITHUB_ENV"], "a") as f:
            f.write("TOKEN="+r.json()["token"]+"\n")
        EOF

    - name: Clone NUEDC-Core submodule
      run: git clone https://x-access-token:$TOKEN@github.com/vilesmeier/NUEDC-Core.git NUEDC-Core

    - name: Generate Doxygen
      run: doxygen Doxyfile

    - name: Build and Deploy MkDocs
      run: mkdocs gh-deploy --force --clean
